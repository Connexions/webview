    <script>
      tinymce.init({
        selector: '#notes',
        paste_data_images: true,
      });
    </script>
<script>
var loaded = 0;
var user = "0";
var opened = false;
//var index = 0;

function toggleFullScreen() {
  if ((document.fullScreenElement && document.fullScreenElement !== null) ||    
   (!document.mozFullScreen && !document.webkitIsFullScreen)) {
    if (document.documentElement.requestFullScreen) {  
      document.documentElement.requestFullScreen();  
    } else if (document.documentElement.mozRequestFullScreen) {  
      document.documentElement.mozRequestFullScreen();  
    } else if (document.documentElement.webkitRequestFullScreen) {  
      document.documentElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);  
    }  
  } else {  
    if (document.cancelFullScreen) {  
      document.cancelFullScreen();  
    } else if (document.mozCancelFullScreen) {  
      document.mozCancelFullScreen();  
    } else if (document.webkitCancelFullScreen) {  
      document.webkitCancelFullScreen();  
    }  
  }  
}


function show() {
  // Tutorial Link 
  // ********
  // alert("Here is a tutorial you may find useful for learning how to use this note feature: http://localhost:8000/about");
  // ********
  if(opened == true){
    opened = false;
  }
  else{
    opened = true;
    if(parseInt(user) == 3){
      alert("In order to save notes, you must have an OpenStax account! Without an account you are still able to write notes, however you will be unable to save them.")
    }
  }
  var x = document.URL;
  if(loaded == 0 || (document.getElementById("user").value != "" && user != document.getElementById("user").value)){
    loadnotes();
    loaded = 1;
  }

  if(!($('div.fullsize-container.sidebar-open').length)){
    document.getElementsByClassName("fullsize-container")[0].className += " sidebar-open";
  }
  if(document.getElementById("notesbox").style.display == "none"){
    document.getElementsByClassName("table-of-contents")[0].className += " hidden";
    document.getElementById("notesbox").style.display ="";    
  }
  else{
    document.getElementById("notesbox").style.display ="none";
    document.getElementsByClassName("fullsize-container sidebar-open")[0].className = "fullsize-container"
   }
}

function detect(){
  document.getElementsByClassName("table-of-contents hidden")[0].className = "table-of-contents";
  if(document.getElementById("notesbox").style.display == ""){
    document.getElementById("notesbox").style.display ="none";
  }
}


// Tutorial Link Function
// ********

// ********


// Font Manipulation
// *********
var fontsize = 0;

function alterfontvar(input){
  var fontsize = (2 * input) + 10;
  var str_value = fontsize.toString();
  changefontsize(str_value);
}

function changefontsize(input2){
  document.getElementsByClassName("inner-format")[0].className = "inner-format";
  document.getElementsByClassName("inner-format")[0].className += " "+"size"+input2;
}
// *********

function exportnotes(){

  var index = 0;
  var exportfile = "";
  var sections = document.getElementsByClassName("title");
  for (section in sections){
    //document.getElementById("notes").value = document.getElementById("notes").value + document.getElementsByTagName("h2")[0].textContent.trim().substring(10).trim();//sections[index].textContent.trim();
    
    //break;


    user = document.getElementById("user").value;
    var name = String(sections[index].textContent.trim());
    //document.getElementById("notes").value += "\n"+name;
    var xhttp = new XMLHttpRequest();
    //xhttp.onreadystatechange = function() {
      //if (xhttp.readyState == 4 && xhttp.status == 200) {
        //exportfile += xhttp.responseText;
        //exportfile += "\n";
        //document.getElementById("notes").value += xhttp.responseText;
      //}
    //};
    if(parseInt(user) == 0){
      xhttp.open("GET", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+name+".txt", false);}
    else{
      xhttp.open("GET", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+user+"/"+name+".txt", false);
    }
    xhttp.send();
    if (!xhttp.responseText.includes("NoSuchKey")){
      exportfile += xhttp.responseText;
      exportfile += "\n\n---\n\n";
    }
    //document.getElementById("notes").value += "\n " + exportfile;
    index += 1;
    //document.getElementById("notes").value += sections[index].textContent.trim() + "\n";
    if (index == 10){
      break;
    }
    
  }

  //document.getElementById("notes").value += "\n done";

  var xhttpp = new XMLHttpRequest();
  if(parseInt(user) == 0){
    xhttpp.open("PUT", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+"export"+".doc", false);
    var url = "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/export.doc";
  }
  else{
    xhttpp.open("PUT", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+user+"/"+"export"+".doc", false);
    var url = "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+user+"/export.doc";
  }
  //document.getElementById("notes").value = "header";
  xhttpp.setRequestHeader('Content-Disposition', 'attachment');
  xhttpp.send(exportfile);

  //document.getElementById("notes").value = "Export Complete";
  //document.getElementById("downloadme").style.display = "";
  
  var xhttppp = new XMLHttpRequest();
  if(parseInt(user) == 0){
    xhttppp.open("GET", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+"export"+".doc", false);
  }
  else{
    xhttppp.open("GET", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+user+"/"+"export"+".doc", false);
  }
  //xhttppp.setRequestHeader('Content-Disposition', 'attachment');
  //xhttppp.setRequestHeader('Content-type', 'application/vnd.ms-word');
  xhttppp.send();
  document.getElementById("link").href=url;
  //document.getElementById("notes").value = "the endnl..";
  window.open(url, '_blank');
}

function save(){
  var x = document.URL;
  localStorage.setItem(String(x), document.getElementById("notes").value);
}

function revert(){

}

function loadnotes() {
  user = document.getElementById("user").value;
  var xhttp = new XMLHttpRequest();
  document.getElementById("notes").value = "";
  xhttp.onreadystatechange = function() {
    if (xhttp.readyState == 4 && xhttp.status == 200) {
      // old load for regular textarea
      //document.getElementById("notes").value = xhttp.responseText;
      tinymce.activeEditor.execCommand('mceSetContent', false, xhttp.responseText);
    }
  };
  if(parseInt(user) == 0){
    xhttp.open("GET", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+document.getElementsByTagName("h2")[0].textContent.trim().substring(10).trim()+".txt", true);}

  else{
    xhttp.open("GET", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+user+"/"+document.getElementsByTagName("h2")[0].textContent.trim().substring(10).trim()+".txt", true);
  }
  
  xhttp.send();
}

function savenotes() {
  user = document.getElementById("user").value;
  var xhttp = new XMLHttpRequest();
  if(parseInt(user) == 0){
    xhttp.open("PUT", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+document.getElementsByTagName("h2")[0].textContent.trim().substring(10).trim()+".txt", true);}
  else{
    xhttp.open("PUT", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+user+"/"+document.getElementsByTagName("h2")[0].textContent.trim().substring(10).trim()+".txt", true);
  }
  xhttp.send(tinymce.activeEditor.getContent());
  //old save for regular textarea
  //xhttp.send(document.getElementById("notes").value);
}

function hidedownload(){
  document.getElementById("downloadme").style.display = "none";
  window.open('https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/1/export.doc');
}

function format(){
  document.getElementById("notes").value = document.getElementsByTagName("h1")[0].textContent.trim();
  document.getElementById("notes").value += "\n\n";
  document.getElementById("notes").value += document.getElementsByClassName("title-chapter")[0].textContent.trim();
  document.getElementById("notes").value += " - ";
  document.getElementById("notes").value += document.getElementsByTagName("h2")[0].textContent.trim().substring(10).trim();
}

</script>
{{#if book}}
  <div class="media-nav{{#is status 'publishing'}} publishing{{/is}}">
    <div class="media-toolbar">
      {{#unless _hideProgress}}
        <button class="toggle contents btn" role="button" onclick="detect()">
          <span class="fa fa-th-list"></span>
           <span class="text">Contents</span>
           <span class="fa fa-plus open-indicator"></span>
        </button>
        <button class="toggle notes btn" role="button" onclick="show()">
          <span class="fa fa-file-text-o"></span>
          <span class="text">Notes</span>
          <span class="fa fa-plus open-indicator"></span>
        </button>

        <a href="https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/1/export.doc" download id="link">
          <button class="download btn" role="button" id="downloadme" onclick="hidedownload()" style="display:none;">
          <span class="fa fa-cloud-download"></span>
          <span class="text">Download</span>
          </button>
        </a>

        <div class="searchbar">
          <span class="fa fa-search"></span>
          <input class="find form-control" type="search" placeholder="Search this book" value="{{searchTerm}}" />
        </div>
      {{/unless}}
      <div class="media-navbar">
        <div class="book-nav" aria-busy="true">
          {{#if back}}
            <a class="nav back" href="{{back}}" data-trigger="false">Back</a>
          {{else}}
            <div class="nav back disabled">Back</div>
          {{/if}}

          {{#unless _hideProgress}}
            <div class="progress">
              <div class="secondary progress-bar" style="width: {{percent page pages}}%;"></div>
            </div>
          {{else}}
            <div class="back-to-top">
              <a href="#">Back to Top</a>
            </div>
          {{/unless}}

          {{#if next}}
            <a class="nav next" href="{{next}}" data-trigger="false">Next</a>
          {{else}}
            <div class="nav next disabled">Next</div>
          {{/if}}
        </div>
      </div>
      </div>
    </div>
  </div>
{{/if}}
