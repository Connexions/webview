    <script>
      tinymce.init({
        selector: '#notes',
        paste_data_images: true,
        menubar: false,
        height : "480",
        image_dimensions: false,
        plugins: "image",
        plugins: "textcolor",
        toolbar1: 'insertfile undo redo | styleselect | bold italic |  alignleft aligncenter alignright alignjustify | bullist numlist outdent indent',
        toolbar2: 'fontsizeselect | forecolor backcolor } ' ,
        fontsize_formats: '8pt 10pt 12pt 14pt 18pt 24pt 36pt',
      });
    </script>

<script>
$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
});
</script>

<script>
// Flag if notes have already been loaded
var loaded = 0;

// Unique user ID, used for determining where to save notes and where to load them from
var user = "0";

// Flag for if the notes sidebar is currently open
var opened = false;

// Toggles the browser's full screen
function toggleFullScreen() {
  if ((document.fullScreenElement && document.fullScreenElement !== null) ||    
   (!document.mozFullScreen && !document.webkitIsFullScreen)) {
    if (document.documentElement.requestFullScreen) {  
      document.documentElement.requestFullScreen();  
    } else if (document.documentElement.mozRequestFullScreen) {  
      document.documentElement.mozRequestFullScreen();  
    } else if (document.documentElement.webkitRequestFullScreen) {  
      document.documentElement.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);  
    }  
  } else {  
    if (document.cancelFullScreen) {  
      document.cancelFullScreen();  
    } else if (document.mozCancelFullScreen) {  
      document.mozCancelFullScreen();  
    } else if (document.webkitCancelFullScreen) {  
      document.webkitCancelFullScreen();  
    }  
  }  
}

// Opens and closes the sidebar containing the notes textbox
function show() {
  if(opened == true){
    opened = false;
  }
  else{
    opened = true;

    // User ID 3 corresponds to a user without an account, 3 can still save and load notes, this is just to demonstrate what a guest user trying to take notes would see
    if(parseInt(user) == 3){
      alert("In order to save notes, you must have an OpenStax account! Without an account you are still able to write notes, however you will be unable to save them.")
    }
  }

  var x = document.URL;
  if(loaded == 0 || (document.getElementById("user").value != "" && user != document.getElementById("user").value)){
    loadnotes();
    loaded = 1;
  }

  if(!($('div.fullsize-container.sidebar-open').length)){
    document.getElementsByClassName("fullsize-container")[0].className += " sidebar-open";
  }
  if(document.getElementById("notesbox").style.display == "none"){
    document.getElementsByClassName("table-of-contents")[0].className += " hidden";
    document.getElementById("notesbox").style.display ="";    
  }
  else{
    document.getElementById("notesbox").style.display ="none";
    document.getElementsByClassName("fullsize-container sidebar-open")[0].className = "fullsize-container"
   }
}

function detect(){
  document.getElementsByClassName("table-of-contents hidden")[0].className = "table-of-contents";
  if(document.getElementById("notesbox").style.display == ""){
    document.getElementById("notesbox").style.display ="none";
  }
}

// Font Manipulation
// *********
var fontsize = 0;

function alterfontvar(input){
  var fontsize = (2 * input) + 10;
  var str_value = fontsize.toString();
  changefontsize(str_value);
}

function changefontsize(input2){
  document.getElementsByClassName("inner-format")[0].className = "inner-format";
  document.getElementsByClassName("inner-format")[0].className += " "+"size"+input2;
}
// *********

// Exports notes from all sections that notes have been taken on into an html document
function exportnotes(){

  var index = 0;

  // Write the beginning of the export document
  var exportfile = "<!DOCTYPE html>";
  exportfile += "\n";
  exportfile += '<html lang="en-US">';
  exportfile += "\n";
  exportfile += "<html>";
  exportfile += "\n";
  exportfile += "<head>";
  exportfile += "\n";
  exportfile += '<meta charset="utf-8">';
  exportfile += "\n";
  exportfile += "</head>";
  exportfile += "\n";
  exportfile += "<body>";
  exportfile += "\n";

  var sections = document.getElementsByClassName("title");
  for (section in sections){

    // Unique user ID, used to determine where to pull notes from and where to store the export
    user = document.getElementById("user").value;

    // Name of the current section, will be used as the file name
    var name = String(sections[index].textContent.trim());
    var xhttp = new XMLHttpRequest();

    // Pull notes from address in this style 
    // https://LOCATION.amazonaws.com/BUCKETNAME/notes/USER_ID/FILENAME.txt
    if(parseInt(user) == 0){
      xhttp.open("GET", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+name+".txt", false);
    }

    else{
      xhttp.open("GET", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+user+"/"+name+".txt", false);
    }

    xhttp.send();
    if (!xhttp.responseText.includes("NoSuchKey")){
      exportfile += xhttp.responseText;
      exportfile += "<br><br><hr><br><br>";
    }

    // Limiting the export to checking the first ten sections for notes for testing purposes and to not go above free bucket GET/PUT request limits for AWS
    index += 1;
    if (index == 10){
      break;
    } 

  }

  // Save exported document in to bucket in this style
  // https://LOCATION.amazonaws.com/BUCKETNAME/notes/USER_ID/export.html
  var xhttpp = new XMLHttpRequest();
  if(parseInt(user) == 0){
    xhttpp.open("PUT", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+"export"+".html", false);
    var url = "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/export.html";
  }

  else{
    xhttpp.open("PUT", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+user+"/"+"export"+".html", false);
    var url = "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+user+"/export.html";
  }
  
  xhttpp.setRequestHeader('Content-Type', 'text/html');
  exportfile += "</body>";
  exportfile += "\n";
  var count = (exportfile.match(/img src=/g) || []).length;
  for (i = 0; i < (count+1); i++) {
    var exportfile = exportfile.replace('../../', 'https://cnx.org/');
  }

  exportfile += "</html>";
  xhttpp.send(exportfile);

  // Open the compiled notes in a new tab
  window.open(url, '_blank');
}

// Load the notes associated with the current section into the notes textbox
function loadnotes() {
  user = document.getElementById("user").value;
  var xhttp = new XMLHttpRequest();
  tinymce.activeEditor.execCommand('mceSetContent', false, "");
  xhttp.onreadystatechange = function() {
    if (xhttp.readyState == 4 && xhttp.status == 200) {
      tinymce.activeEditor.execCommand('mceSetContent', false, xhttp.responseText);
    }
  };

  // Pull notes from address in this style 
  // https://LOCATION.amazonaws.com/BUCKETNAME/notes/USER_ID/FILENAME.txt
  if(parseInt(user) == 0){
    xhttp.open("GET", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+document.getElementsByTagName("h2")[0].textContent.trim().substring(10).trim()+".txt", true);}

  else{
    xhttp.open("GET", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+user+"/"+document.getElementsByTagName("h2")[0].textContent.trim().substring(10).trim()+".txt", true);
  }
  
  xhttp.send();
}

// Save the notes currently in the notes textbox
function savenotes() {
  user = document.getElementById("user").value;
  var xhttp = new XMLHttpRequest();

  // Save notes to address in this style 
  // https://LOCATION.amazonaws.com/BUCKETNAME/notes/USER_ID/FILENAME.txt
  if(parseInt(user) == 0){
    xhttp.open("PUT", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+document.getElementsByTagName("h2")[0].textContent.trim().substring(10).trim()+".txt", true);
  }

  else{
    xhttp.open("PUT", "https://s3-us-west-2.amazonaws.com/testnotesbucket/notes/"+user+"/"+document.getElementsByTagName("h2")[0].textContent.trim().substring(10).trim()+".txt", true);
  }

  xhttp.send(tinymce.activeEditor.getContent());
}

// Put the book title, section number, and section title in the notebox
function format(){
  text = '<h3 style="text-align: center;">';
  text += document.getElementsByTagName("h1")[0].textContent.trim();
  text += "<br><br>";
  text += document.getElementsByClassName("title-chapter")[0].textContent.trim();
  text += " - ";
  text += document.getElementsByTagName("h2")[0].textContent.trim().substring(10).trim();
  text += "</h3>";

  tinymce.activeEditor.execCommand('mceSetContent', false, text);
}

</script>
{{#if book}}
  <div class="media-nav{{#is status 'publishing'}} publishing{{/is}}">
    <div class="media-toolbar">
      {{#unless _hideProgress}}
        <button class="toggle contents btn" role="button" onclick="detect()">
          <span class="fa fa-th-list"></span>
           <span class="text">Contents</span>
           <span class="fa fa-plus open-indicator"></span>
        </button>
        <button class="toggle notes btn" role="button" onclick="show()">
          <span class="fa fa-file-text-o"></span>
          <span class="text">Notes</span>
          <span class="fa fa-plus open-indicator"></span>
        </button>

        <div class="searchbar">
          <span class="fa fa-search"></span>
          <input class="find form-control" type="search" placeholder="Search this book" value="{{searchTerm}}" />
        </div>
      {{/unless}}
      <div class="media-navbar">
        <div class="book-nav" aria-busy="true">
          {{#if back}}
            <a class="nav back" href="{{back}}" data-trigger="false">Back</a>
          {{else}}
            <div class="nav back disabled">Back</div>
          {{/if}}

          {{#unless _hideProgress}}
            <div class="progress">
              <div class="secondary progress-bar" style="width: {{percent page pages}}%;"></div>
            </div>
          {{else}}
            <div class="back-to-top">
              <a href="#">Back to Top</a>
            </div>
          {{/unless}}

          {{#if next}}
            <a class="nav next" href="{{next}}" data-trigger="false">Next</a>
          {{else}}
            <div class="nav next disabled">Next</div>
          {{/if}}
        </div>
      </div>
      </div>
    </div>
  </div>
{{/if}}
